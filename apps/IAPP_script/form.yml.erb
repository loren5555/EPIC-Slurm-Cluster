<%
  require 'yaml'

  partfile = '/etc/ood/config/site.d/partitions.yml'
  parts    = File.exist?(partfile) ? YAML.safe_load(File.read(partfile)) : {}

  DEFAULTS = { 'gpu_max' => 0, 'cpu_max' => 4, 'mem_max_gb' => 16 }
  parts    = parts.transform_values { |cfg| DEFAULTS.merge(cfg || {}) }

  def q(s)
    s.to_s.gsub("'", "''")
  end

  # [ 'Label', 'value', data-...: ..., data-...: ..., ... ]
  def part_option_line(name, cfg)
    label   = (cfg['label'] || name).to_s # Label
    part    = (cfg['partition'] || name).to_s # Partition
    resource = (cfg['resource_type'] || "cpu").to_s # Resource type

    cpu_max = cfg['cpu_max'].to_i
    gpu_max = cfg['gpu_max'].to_i
    mem_max = cfg['mem_max_gb'].to_i

    data_pairs = []

    data_pairs << "data-set-resource-partition: '#{part}'"
    data_pairs << "data-set-resource-type: '#{resource}'"

    data_pairs << "data-label-cpus-per-task: 'CPU Cores for one task (1-#{cpu_max})'"
    data_pairs << "data-max-cpus-per-task: #{cpu_max}"

    # data_pairs << "data-label-memory: 'Memory (GB, 1-#{mem_max})'"
    # data_pairs << "data-max-memory: #{mem_max}"

    if gpu_max <= 0
      data_pairs << "data-label-gpus-per-task: 'Number of GPUs for one task (0-#{gpu_max})'"
      data_pairs << "data-hide-gpus-per-task: true"
      data_pairs << "data-set-gpus-per-task: 0"
    else
      data_pairs << "data-hide-gpus-per-task: false"
      data_pairs << "data-label-gpus-per-task: 'Number of GPUs for one task (0-#{gpu_max})'"
      data_pairs << "data-max-gpus-per-task: #{gpu_max}"
    end

    # 拼成一行 flow sequence
    "[ '#{q(label)}', '#{q(part)}', #{data_pairs.join(', ')} ]"
  end

  generated_options = parts.map { |name, cfg| part_option_line(name, cfg) }
                           .join("\n      - ")
%>

cluster:
  - "epic"

form:
  - partition_selection
  - resource_partition
  - resource_type
  - cpus_per_task
  - gpus-per-task
  - bc_num_hours
  - working_dir
  - script
  - array
  - auto_accounts
  - mail_user
  - mail_type

attributes:
  partition_selection:
    display: false
    label: "Select Partition"
    widget: select
    options:
      - <%= generated_options %>
    value: "cpu"

  resource_partition:
    display: true
    label: "Resource Partition"
    widget: "text_field"
    readonly: true
    value: "cpu"

  resource_type:
    display: true
    widget: "text_field"
    readonly: true
    value: "cpu"

  cpus_per_task:
    label: "CPU Cores for each task"
    widget: "number_field"
    value: 4
    min: 1
    max: 128
    display: true

  gpus-per-task:
    label: "Number of GPUs"
    widget: "number_field"
    value: 0
    min: 0
    max: 8
    display: true

  memory:
    label: "Memory (GB)"
    widget: "number_field"
    value: 128
    min: 0
    max: 1024
    display: true

  bc_num_hours:
    label: "Number of hours (max 336h, 14 days)"
    value: 4
    min: 0
    max: 336
    display: true

  working_dir:
    widget: "text_field"
    label: "Working Directory"
    help: "Working directory on the target node."
    value: "<%= ENV['HOME'] %>"
    display: true

  script:
    widget: "text_field"
    label: "Path to the target script on the target node."
    display: true

  array:
    label: "Job array index values" 
    widget: "text_field"
    help: |+
        Enter 1-N to run N tasks in parallel. 

        Enter 1-T%P to run up to T tasks in total with at most P running concurrently.

        The task ID will be passed to the script.

        Examples: `1-10` → 10 in parallel; `1-20%3` → 20 total, 3 at a time.     

        Ensure (parallel × cores-per-task) ≤ max cores and (parallel × gpus-per-task) ≤ max gpus; otherwise jobs won’t start and will remain queued indefinitely.
    display: true
    value: 1

  modules:
    label: "Modules to Load (optional)"
    widget: text_field
    value: ""
    # help: "Enter modules separated by spaces, e.g., 'cuda/12.4 python/3.11'. Leave empty if not needed."
    display: true

  mail_user:
    label: "Notification e-mail"
    help:  "E-mail for receiving notifications."
    value: "<%= ENV['OOD_USER_EMAIL'] || Etc.getlogin + '@hust.edu.cn' %>"

  mail_type:
    label: "Notify on"
    widget: "select"
    options:
      - ["None", "NONE"]
      - ["Begin, End & Fail (Recommended)", "BEGIN,END,FAIL"]
      - ["Begin", "BEGIN"]
      - ["End & Fail", "END,FAIL"]
      - ["All events", "ALL"]
    value: "NONE"